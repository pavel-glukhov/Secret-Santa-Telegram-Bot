## Secret Santa Telegram Bot

## Описание
Бот для организации игры в Тайного Санту через Telegram. Позволяет участникам удобно проводить жеребьёвку, 
обмениваться пожеланиями и получать результаты. Бот так же позволяет анонимно вести переписку между получателем подарка и тайным Сантой.

Поддержка 4-х языков, перевод был осуществлен машинным способом.
Включенные языки:

1. RU
2. ENG
3. KAZ
4. UK

### Текущая версия: 0.4.1

---
## История изменений

**v 0.4.1** 
* Добавлена возможность подключаться к комнате используя URL.
* Внесены изменения в диалоги.
* Исправлена логика приложения. 

**v 0.4** 
* Все ORM запросы были переписаны на async.
* Исправлены некоторые баги связанные с интерфейсом.

**v 0.3** 
* Убран старый способ указания даты жеребьевки.
* Добавлен интерактивный календарь и выбор случайного времени рассылки результатов между периодами времени.
* Исправлены некоторые баги и недочеты. 

**v 0.2.2** 
* Исправлены некоторые баги связанные с отправкой сообщений.
* Оптимизированы некоторые SQL запросы.

**v 0.2.1** 
* Исправлен баг с получением желаний игрока в комнате.
* Обновлены словари с языками.

**v 0.2**
* Приложение переписано с Aiogram 2 на 3 версию.
* SQL запросы перенесены с Tortoise ORM на SQLAlchemy.
* Добавлена поддержка других языков.
* Исправлены различные баги.

**v 0.1**
* Выпуск пробной версии бота.

---

Схема: https://miro.com/app/board/uXjVNxWmMtE=/?share_link_id=603886678614


### Стек

1. Aiogram 3
2. FastAPI
3. SQLAlchemy 2
4. Alemnic
5. PostgreSQL
6. Redis

1. #### Создание персональных комнат

    - Каждый желающий может создать комнату для неограниченного количества людей.
        - При создании нужно указать:
            - **Имя комнаты**
            - **Бюджет для своей компании игроков**
            - **Свои пожелания для подарка**

      ```Переменная окружения USER_ROOMS_LIMIT задает лимит колличества комнат, которыми может управлять один игрок.```

      ```При создании комнаты, генерируется случайный уникальный номер, длина номеера задается параметром ROOM_NUBER_LENGTH. ```
2. #### Вход в существующую комнату по ID комнаты
3. #### Управление своим профилем
    - Бот позволяет внести и изменить такие данные как:
        - **Имя и Фамилия**
        - **Домашний Адрес**
        - **Номер Телефона**
        - **Часовой пояс**
        - **Разрешено полное удаление внесенных данных**

   ```Адрес и номер телефона шифруется в базе Fernet алгоритмом в целях безопасности.```

4. #### Управление комнатами
    - Меню управления комнатами для обычного пользователя:
        - **Выйти из комнаты**
        - **Изменить пожелания**
    - Меню управления комнатами для владельца:
        - **Начать игру** - позволяет установить время рассылки
            - **Указать часовой пояс** - Установить часовой пояс для конкретной зоны
        - **Изменить пожелания**
        - **Настройки**
            - **Удалить комнату**
            - **Изменить имя комнаты**
            - **Изменить владельца**
            - **Изменить бюджет комнаты**

      ```Администратор комнаты не может выйти из нее, пока не передаст управление другому. Комната может быть только окончательно удалена.```

      ```Если при жеребьевке не оказалось нужного колличества игроков, комнату можно активировать повторно.```
5. #### Коммуникация
   После разыгрывания ролей в игре, в комнатах доступны 2 опции, позволяющие коммуницировать анонимно между получателем
   и отправителем посредством бота.
    - **Отправка сообщения Тайному Санте**
    - **Отправка сообщения получателю**

### Запуск Бота:
- Создать свой .env файл по шаблону .env.example
- Для генерации параметра **ENCRYPT_SECRET_KEY** в **.env** файле, используйте: 
     ```
        python .\manage.py generate_key
    ```

#### Ручной запуск:


- Установить PostgreSQL и Redis, сконфигурировать и создать БД.
    - Redis требует включения доступа по паролю:
       ```
      sudo nano /etc/redis/redis.conf
      # requirepass foobared

    -  ```pip install -r requirements.txt ```
    -  ```alembic upgrade head ```
    -  ```uvicorn app.core.cli:create_app ```
    


#### В Docker контейнере:

- Установить Docker https://docs.docker.com/engine/install/ubuntu/
    - Создать свой .env файл по шаблону .env.example
  
- Запуск Docker Compose
    -  ```docker-compose up -d ```
- Пересборка при обновлении кода
    -  ```docker-compose build ```
- Перезапуск контейнеров с пересобранными образами:
    -  ```docker-compose up -d --build ```




  Миграции
     ```console
       docker exec -t <backend container> alembic upgrade head
     ```

### Права доступа:

- Что бы добавить Superuser права пользователю, выполните:
     ```console
        python .\manage.py set_superuser <telegram_user_id>
     ```
- Что бы удалить их, выполните ****
     ```console
         python .\manage.py remove_superuser <telegram_user_id>
     ```
- ### Регистрация вебхука
    ```console
      python .\manage.py register_webhook
    ```

  Или сформируйте и сделайте GET запрос
   ```https://api.telegram.org/bot{telegram_token}/setWebhook?url=https://{domain_name}/bot/ ```

  Пример:
   ```https://api.telegram.org/bot1234567890:AAABBBCCCDDDEEEFFF0000000_FFFFF/setWebhook?url=https://e87d-5-76-101-111.ngrok-free.app/bot/ ```

- Так же, для работы **Telegram Login Widget**, требуется зарегистрировать домен вашего сайта в **@BotFather** используя
  команду **/setdomain**

### Бекапы

Бекапить базу данных можно с помощью команды ниже, добавленной в cron:
``docker exec -t <имя_контейнера> pg_dump -U <имя_пользователя> <имя_базы_данных> > <имя_файла>.sql
``

``Или добавить готовый скрипт в cron находящийся в deploy\backup. Нужно будет внести настройки под себя.
 ``